# email_verifications 表

邮箱验证表，存储邮箱验证码和验证状态。

## 表结构

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|---------|------|
| `id` | `uuid` | NO | `gen_random_uuid()` | 主键，自动生成的UUID |
| `email` | `varchar(255)` | NO | null | 待验证的邮箱地址 |
| `code` | `varchar(6)` | NO | null | 6位数字验证码 |
| `anon_id` | `varchar(255)` | YES | null | 关联的匿名用户ID |
| `verified` | `boolean` | NO | `false` | 是否已验证 |
| `expires_at` | `timestamp with time zone` | NO | null | 验证码过期时间 |
| `created_at` | `timestamp with time zone` | NO | `NOW()` | 记录创建时间 |
| `updated_at` | `timestamp with time zone` | NO | `NOW()` | 记录更新时间 |

## 索引

- **主键**: `id`
- **普通索引**: `email` (用于快速查找邮箱的验证码)
- **复合索引**: `email, code` (用于验证码验证)
- **普通索引**: `expires_at` (用于清理过期记录)

## 字段说明

### `email`
- 待验证的邮箱地址
- 与 `subscribers` 表的 `email` 字段关联

### `code`
- 6位数字验证码
- 系统随机生成 (100000-999999)
- 每个邮箱同时只能有一个有效验证码

### `anon_id`
- 关联的匿名用户ID（可选）
- 用于将验证记录与特定用户会话关联

### `verified`
- 验证状态标记
- `false`: 未验证 (默认)
- `true`: 已验证

### `expires_at`
- 验证码过期时间
- 通常设置为创建时间 + 10分钟
- 过期后验证码无效

## 用途

1. **邮箱验证**: 存储和管理邮箱验证码
2. **安全控制**: 确保验证码的时效性和唯一性
3. **用户体验**: 支持重发验证码功能

## 相关API

- `POST /api/send-verification-code` - 发送验证码
- `POST /api/verify-email-code` - 验证验证码
- `GET /api/check-email-verification` - 检查验证状态

## 示例数据

```sql
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "email": "user@example.com",
  "code": "123456",
  "anon_id": "anon_user_123",
  "verified": false,
  "expires_at": "2024-09-23T10:10:00Z",
  "created_at": "2024-09-23T10:00:00Z",
  "updated_at": "2024-09-23T10:00:00Z"
}
```

## 业务逻辑

### 发送验证码流程
1. 检查邮箱格式有效性
2. 清理该邮箱的旧验证码记录
3. 生成新的6位验证码
4. 设置10分钟过期时间
5. 发送邮件到用户邮箱

### 验证流程
1. 查找匹配的邮箱和验证码
2. 检查是否已过期
3. 检查是否已被使用
4. 验证成功后标记为已验证
5. 更新 `subscribers` 表的验证状态

### 清理机制
1. 验证成功后清理该邮箱的其他验证码
2. 定期清理过期的验证码记录
3. 发送新验证码时清理旧记录

## 安全考虑

1. **时效性**: 验证码10分钟内有效
2. **唯一性**: 每个邮箱同时只能有一个有效验证码
3. **限流**: API 层面限制发送频率
4. **一次性**: 验证码使用后立即失效

## 注意事项

1. 验证码为6位纯数字
2. 同一邮箱的旧验证码会被新验证码覆盖
3. 过期时间固定为10分钟
4. 验证成功后会自动清理相关记录
5. 支持手动清理过期记录的定时任务

---

*表结构记录时间: 2024-09-23*